@page "/"
@attribute [Authorize]

@using ExamsSchedule.Models
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0 text-dark">Dashboard</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard v1</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<section class="content">
    <div class="container-fluid">

        <AuthorizeView Roles="Admin">
            <Authorized>
                <div class="row">
                    @foreach (var item in DashboardItems)
                    {
                        <div class="col-lg-3 col-6">
                            <div class="small-box" style="background-color: @item.Color;color: #fff !important;">
                                <div class="inner">
                                    <h3>@item.Number</h3>

                                    <p>@item.Text</p>
                                </div>
                                @if (string.IsNullOrEmpty(item.Link))
                                {
                                    <a href="@item.Link" class="small-box-footer" style="visibility: hidden;">
                                        More info <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                }
                                else
                                {
                                    <a href="@item.Link" class="small-box-footer">
                                        More info <i class="fas fa-arrow-circle-right"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    }

                </div>
                @*<div class="row">
                        <div class="col-lg-3 col-6">
                            <div class="small-box bg-info">
                                <div class="inner">
                                    <h3>@TotalExams</h3>

                                    <p>Number of Exams Proctored 30 days</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-bag"></i>
                                </div>
                                <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                            </div>
                        </div>
                        <div class="col-lg-3 col-6">
                            <div class="small-box bg-success">
                                <div class="inner">
                                    <h3>@TotalFlagExams<sup style="font-size: 20px"></sup></h3>

                                    <p>System Identified Flags Last 30 Days</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-stats-bars"></i>
                                </div>
                                <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                            </div>
                        </div>
                        <div class="col-lg-3 col-6">
                            <div class="small-box bg-warning">
                                <div class="inner">
                                    <h3>@TotalVerifiedExams</h3>

                                    <p>Exams Verified - System Last 30 Days</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-person-add"></i>
                                </div>
                                <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                            </div>
                        </div>
                        <div class="col-lg-3 col-6">
                            <div class="small-box bg-danger">
                                <div class="inner">
                                    <h3>@TotalPendingExams</h3>

                                    <p>Total Pending Verification</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-pie-graph"></i>
                                </div>
                                <a href="/verifyexam" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                            </div>
                        </div>
                        <div class="col-lg-3 col-6">
                            <div class="small-box bg-danger">
                                <div class="inner">
                                    <h3>@TotalVerifiedUserExams</h3>

                                    <p>Exams Verified - User Last 30 Days</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-pie-graph"></i>
                                </div>
                                <a href="#" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                            </div>
                        </div>
                    </div>*@
            </Authorized>
        </AuthorizeView>

        <AuthorizeView Roles="User">
            <Authorized>
                <div class="row">
                    @foreach (var item in DashboardItems)
                    {
                        <div class="col-lg-3 col-6">
                            <div class="small-box" style="background-color: @item.Color;color: #fff !important;">
                                <div class="inner">
                                    <h3>@item.Number</h3>

                                    <p>@item.Text</p>
                                </div>
                                <div class="icon">
                                    <i class="ion ion-bag"></i>
                                </div>
                                <a href="@item.Link" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                            </div>
                        </div>
                    }

                </div>
                @*<div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3>@TotalStudents</h3>

                                <p>Number of Students</p>
                            </div>
                            <div class="icon">
                                <i class="ion ion-bag"></i>
                            </div>
                            <a href="/students" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success">
                            <div class="inner">
                                <h3>@LastFiveDays<sup style="font-size: 20px"></sup></h3>

                                <p>Number of Archive last 5 Days</p>
                            </div>
                            <div class="icon">
                                <i class="ion ion-stats-bars"></i>
                            </div>
                            <a href="/searchstudent" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3>@LastThirtyDays</h3>

                                <p>Number of Archive last 30 Days</p>
                            </div>
                            <div class="icon">
                                <i class="ion ion-person-add"></i>
                            </div>
                            <a href="/searchstudent" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3>@LastNintyDays</h3>

                                <p>Number of Archive last 90 Days</p>
                            </div>
                            <div class="icon">
                                <i class="ion ion-pie-graph"></i>
                            </div>
                            <a href="/searchstudent" class="small-box-footer">More info <i class="fas fa-arrow-circle-right"></i></a>
                        </div>
                    </div>*@

            </Authorized>
        </AuthorizeView>
    </div>
</section>

@using ExamsSchedule.Services
@using Microsoft.AspNetCore.Identity
@inject ExamStatusService examStatusService
@inject DashboardService dashboardService
@inject StudentService studentService
@inject SearchStudentService searchStudentService
@inject LiveProctorService liveProctorService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SignInManager<IdentityUser> SignInManager
@code{

    //public int TotalExams { get; set; }
    //public int TotalFlagExams { get; set; }
    //public int TotalVerifiedExams { get; set; }
    //public int TotalPendingExams { get; set; }
    //public int TotalVerifiedUserExams { get; set; }
    //public int TotalStudents { get; set; }
    //public int LastFiveDays { get; set; }
    //public int LastThirtyDays { get; set; }
    //public int LastNintyDays { get; set; }
    //public string lastnintydays = "Last 90 Days";

    private List<Models.DB.DashboardItems> DashboardItems = new List<Models.DB.DashboardItems>();

    protected override async Task OnInitializedAsync()
    {
        DashboardItems = await dashboardService.GetAllItems();
        //var authstate = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        //var user = authstate.User;

        //if (user != null && user.IsInRole("Admin"))
        //{
        //    var result = await examStatusService.GetAllAsync(m => m.StartedAt.HasValue && m.StartedAt.Value.Date > DateTime.Now.Date.AddDays(-30));

        //    TotalExams = result.Count();
        //    TotalFlagExams = result.Where(m => m.ExamStatus == 30).Count();

        //    TotalVerifiedExams = result.Where(m => m.ExamStatus == 20).Count();

        //    TotalPendingExams = result.Where(m => m.ExamStatus == 40).Count();

        //    TotalVerifiedUserExams = result.Where(m => m.ExamStatus == 50).Count();
        //}
        //else
        //{
        //    TotalStudents = await studentService.GetAllDataCountAsync();
        //    var totalData = (await liveProctorService.GetDataAsync(0, 0, lastnintydays, false));
        //    LastNintyDays = totalData.Count();
        //    LastThirtyDays = totalData.Where(m => m.StartedAt.HasValue && m.StartedAt.Value.Date > DateTime.Now.AddDays(-30)).Count();
        //    LastFiveDays = totalData.Where(m => m.StartedAt.HasValue && m.StartedAt.Value.Date > DateTime.Now.AddDays(-5)).Count();
        //}
    }

}

